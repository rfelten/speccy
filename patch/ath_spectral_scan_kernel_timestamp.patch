From c359fc8eb618603b07b23ba99482a7ce89236f57 Mon Sep 17 00:00:00 2001
From: Robert Felten <robert.felten@gmail.com>
Date: Tue, 26 Jan 2016 09:04:52 +0100
Subject: [PATCH] added timestamp to ath9k spectral scan samples

---
 drivers/net/wireless/ath/ath9k/common-spectral.c | 13 +++++++++++--
 drivers/net/wireless/ath/spectral_common.h       |  5 +++++
 2 files changed, 16 insertions(+), 2 deletions(-)

diff --git a/drivers/net/wireless/ath/ath9k/common-spectral.c b/drivers/net/wireless/ath/ath9k/common-spectral.c
index ec93ddf..a7d4a81 100644
--- a/drivers/net/wireless/ath/ath9k/common-spectral.c
+++ b/drivers/net/wireless/ath/ath9k/common-spectral.c
@@ -15,6 +15,7 @@
  */
 
 #include <linux/relay.h>
+#include <linux/time.h>
 #include "ath9k.h"
 
 static s8 fix_rssi_inv_only(u8 rssi_val)
@@ -51,6 +52,7 @@ int ath_cmn_process_fft(struct ath_spec_scan_priv *spec_priv, struct ieee80211_h
 	int dc_pos;
 	u16 fft_len, length, freq = ah->curchan->chan->center_freq;
 	enum nl80211_channel_type chan_type;
+	struct timespec curr_tm;
 
 	/* AR9280 and before report via ATH9K_PHYERR_RADAR, AR93xx and newer
 	 * via ATH9K_PHYERR_SPECTRAL. Haven't seen ATH9K_PHYERR_FALSE_RADAR_EXT
@@ -68,6 +70,9 @@ int ath_cmn_process_fft(struct ath_spec_scan_priv *spec_priv, struct ieee80211_h
 	if (!(radar_info->pulse_bw_info & SPECTRAL_SCAN_BITMASK))
 		return 0;
 
+	/* prepare timestamp of sample */
+	getnstimeofday(&curr_tm);
+
 	chan_type = cfg80211_get_chandef_type(&common->hw->conf.chandef);
 	if ((chan_type == NL80211_CHAN_HT40MINUS) ||
 	    (chan_type == NL80211_CHAN_HT40PLUS)) {
@@ -134,7 +139,7 @@ int ath_cmn_process_fft(struct ath_spec_scan_priv *spec_priv, struct ieee80211_h
 			ext_nf = ATH_DEFAULT_NOISE_FLOOR;
 
 		length = sizeof(fft_sample_40) - sizeof(struct fft_sample_tlv);
-		fft_sample_40.tlv.type = ATH_FFT_SAMPLE_HT20_40;
+		fft_sample_40.tlv.type = ATH_FFT_SAMPLE_HT20_40_TS;
 		fft_sample_40.tlv.length = __cpu_to_be16(length);
 		fft_sample_40.freq = __cpu_to_be16(freq);
 		fft_sample_40.channel_type = chan_type;
@@ -173,13 +178,15 @@ int ath_cmn_process_fft(struct ath_spec_scan_priv *spec_priv, struct ieee80211_h
 		fft_sample_40.tsf = __cpu_to_be64(tsf);
 
 		tlv = (struct fft_sample_tlv *)&fft_sample_40;
+		tlv->ts_sec = __cpu_to_be64(curr_tm.tv_sec);
+		tlv->ts_nsec = __cpu_to_be32(curr_tm.tv_nsec);
 	} else {
 		u8 max_index, bitmap_w;
 		u16 magnitude;
 		struct ath_ht20_mag_info *mag_info;
 
 		length = sizeof(fft_sample_20) - sizeof(struct fft_sample_tlv);
-		fft_sample_20.tlv.type = ATH_FFT_SAMPLE_HT20;
+		fft_sample_20.tlv.type = ATH_FFT_SAMPLE_HT20_TS;
 		fft_sample_20.tlv.length = __cpu_to_be16(length);
 		fft_sample_20.freq = __cpu_to_be16(freq);
 
@@ -198,6 +205,8 @@ int ath_cmn_process_fft(struct ath_spec_scan_priv *spec_priv, struct ieee80211_h
 		fft_sample_20.tsf = __cpu_to_be64(tsf);
 
 		tlv = (struct fft_sample_tlv *)&fft_sample_20;
+		tlv->ts_sec = __cpu_to_be64(curr_tm.tv_sec);
+		tlv->ts_nsec = __cpu_to_be32(curr_tm.tv_nsec);
 	}
 
 	ath_debug_send_fft_sample(spec_priv, tlv);
diff --git a/drivers/net/wireless/ath/spectral_common.h b/drivers/net/wireless/ath/spectral_common.h
index 0d742ac..191f4c7 100644
--- a/drivers/net/wireless/ath/spectral_common.h
+++ b/drivers/net/wireless/ath/spectral_common.h
@@ -37,11 +37,16 @@ enum ath_fft_sample_type {
 	ATH_FFT_SAMPLE_HT20 = 1,
 	ATH_FFT_SAMPLE_HT20_40,
 	ATH_FFT_SAMPLE_ATH10K,
+	ATH_FFT_SAMPLE_HT20_TS = 11,
+	ATH_FFT_SAMPLE_HT20_40_TS,
+	ATH_FFT_SAMPLE_ATH10K_TS,
 };
 
 struct fft_sample_tlv {
 	u8 type;	/* see ath_fft_sample */
 	__be16 length;
+	__be64 ts_sec;
+	__be32 ts_nsec;
 	/* type dependent data follows */
 } __packed;
 
-- 
1.9.1

